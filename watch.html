<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© | Tunflix</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; direction: rtl; }
    video { width: 80%; max-width: 800px; margin-top: 20px; }
    button { margin: 10px; padding: 10px 20px; }
  </style>
</head>
<body>

  <h1>ğŸ¬ ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h1>

  <!-- Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ -->
  <video id="videoPlayer" controls></video>

  <!-- Ø²Ø± Ù„Ù„Ù…Ø³ØªØ¶ÙŠÙ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ù„Ù‚Ø© -->
  <div id="hostControls">
    <button id="nextEpisodeBtn">â¬…ï¸ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
  </div>

  <script type="module">

    let episodesData = [];

    // ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· mp4 Ø­Ø³Ø¨ Ø§Ù„Ø¬ÙˆØ¯Ø©
    function generateVideoUrl(baseURL, quality) {
      return `${baseURL}${quality}/mp4/file.mp4`;
    }

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBNLxujMnCsvpsfzqqYMVR4l9dT4teu_b8",
      authDomain: "watch-together-fa628.firebaseapp.com",
      databaseURL: "https://watch-together-fa628-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "watch-together-fa628",
      storageBucket: "watch-together-fa628.firebasestorage.app",
      messagingSenderId: "472062861048",
      appId: "1:472062861048:web:3710c75f6b72fef138e50d"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    const isHost = urlParams.get('host') === 'true';
    const roomRef = ref(database, `rooms/${roomId}`);

    const video = document.getElementById('videoPlayer');
    const nextEpisodeBtn = document.getElementById('nextEpisodeBtn');
    const hostControls = document.getElementById('hostControls');

    if (!isHost) {
      hostControls.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø³ØªØ¶ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ù…Ù† ØµÙØ­Ø© Ø¨Ù„ÙˆØ¬Ø± HTML
    async function fetchEpisodesFromBlogger() {
      try {
        const response = await fetch('https://tun-flix.blogspot.com/p/blog-page.html');  // ØºÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø±Ø§Ø¨Ø· ØµÙØ­Ø© Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ù„Ø¯ÙŠÙƒ ÙÙŠ Ø¨Ù„ÙˆØ¬Ø±
        const text = await response.text();

        // ØªØ­ÙˆÙŠÙ„ Ù†Øµ HTML Ø¥Ù„Ù‰ DOM
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');

        // Ø§ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø­Ù„Ù‚Ø§Øª ÙÙŠ Ø¹Ù†ØµØ± UL Ù„Ù‡ id="episodesList" ÙˆÙƒÙ„ LI ÙŠØ­ØªÙˆÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø©
        const listItems = doc.querySelectorAll('#episodesList li');

        episodesData = Array.from(listItems).map(li => ({
          id: parseInt(li.dataset.id),
          title: li.textContent.trim(),
          baseURL: li.dataset.baseurl
        }));

        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø§Øª:', episodesData);

        // Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø§Ø¨Ø¯Ø£ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        startWatching();

      } catch (error) {
        console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ù…Ù† Ø¨Ù„ÙˆØ¬Ø±:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø§Øª.');
      }
    }

    // Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase
    function startWatching() {

      // Ø¶Ø¨Ø· Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Firebase Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
      get(child(roomRef, 'currentEpisode')).then(snapshot => {
        if (!snapshot.exists()) {
          update(roomRef, {
            currentEpisode: 1,
            currentTime: 0,
            isPlaying: false,
            quality: "720p"
          });
        }
      });

      // Ù„Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒØ«ÙŠØ±Ø© Ù„Ù„ÙˆÙ‚Øª
      let lastUpdateTime = 0;

      // Ø§Ù„Ù…Ø³ØªØ¶ÙŠÙ: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ØŒ Ø§Ù„Ø¥ÙŠÙ‚Ø§ÙØŒ ÙˆØªØºÙŠÙŠØ± Ø§Ù„ÙˆÙ‚Øª
      if (isHost) {
        video.addEventListener("play", () => {
          update(roomRef, { isPlaying: true });
        });

        video.addEventListener("pause", () => {
          update(roomRef, { isPlaying: false });
        });

        video.addEventListener("timeupdate", () => {
          const now = Date.now();
          if (now - lastUpdateTime > 1000) { // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
            update(roomRef, { currentTime: video.currentTime });
            lastUpdateTime = now;
          }
        });

        nextEpisodeBtn.addEventListener("click", () => {
          let newEpisodeId = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:", "2");
          newEpisodeId = parseInt(newEpisodeId, 10);
          if (newEpisodeId && episodesData.some(ep => ep.id === newEpisodeId)) {
            update(roomRef, {
              currentEpisode: newEpisodeId,
              currentTime: 0,
              isPlaying: false
            });
          } else {
            alert("Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø© ØºÙŠØ± ØµØ§Ù„Ø­.");
          }
        });
      }

      // Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙˆÙ†: Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      onValue(roomRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        const episode = episodesData.find(ep => ep.id === data.currentEpisode);
        if (!episode) return;

        const videoUrl = generateVideoUrl(episode.baseURL, data.quality || "720p");

        if (video.src !== videoUrl) {
          video.src = videoUrl;
          video.load();
        }

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª Ù…Ø¹ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‡Ø§Ù…Ø´ ØµØºÙŠØ± Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø§Ù„Ù…ØªÙƒØ±Ø±
        if (Math.abs(video.currentTime - data.currentTime) > 1) {
          video.currentTime = data.currentTime;
        }

        if (data.isPlaying && video.paused) {
          video.play().catch(console.error);
        } else if (!data.isPlaying && !video.paused) {
          video.pause();
        }
      });

    }

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ù…Ù† Ø¨Ù„ÙˆØ¬Ø±
    fetchEpisodesFromBlogger();

  </script>
</body>
</html>
